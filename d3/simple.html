<html>
  <head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
      function genData(minX, maxX) {
        var n = Math.round(1 + Math.random() * 9)
        var section = (maxX - minX) / n

        var points = []
        for(var i = 0; i < n; i++) {
          var x = minX + section * i // + Math.random() * section
          var y = Math.random() * 70
          points.push([x, y])
        }
        
        return points
      }
    </script>
    <style>
      svg rect.buy {
        width: 5px;
      }
      svg rect.sell {
        width: 20px;
      }
    </style>
  </head>
  <body>
    <button onClick="updateChart()">Update</button>
    <div id="chart" style="width: 100%; height: 250px;">
      <svg width="100%" height="100%"></svg>
    </div>

    <script>
      d3.select("#chart").style("border", "1px solid black")
      
      // HTML container element
      var boundingRect = d3.select("#chart").node().getBoundingClientRect()
      
      // X / Y Scale
      var padding = 20
      var xScale = d3.scaleLinear().range([padding, boundingRect.width - padding])
      var yScale = d3.scaleLinear().range([boundingRect.height - padding, 0])
      
      // The chart
      var chart = d3.select("svg")

      // Axes
      chart.append("g")
        .attr("class", "x axis")
        .attr("transform", `translate(0, ${boundingRect.height - padding})`)
      chart.append("g")
        .attr("class", "y axis")
        .attr("transform", `translate(${padding}, 0)`)

      function updateBars(data, cssClass, maxY) {
        var bars = chart
          .selectAll(`rect.${cssClass}`)
          .data(data)

        var t = d3.transition().duration(500)

        // EXIT
        bars.exit()
          .style("fill", "red")
          .transition(t)
          .remove()

        // UPDATE
        bars.style("fill", "orange")
          .attr('x', d => xScale(d[0]))
          .attr("height", d => yScale(d[1]))
          .attr('y', d => yScale(maxY - d[1]))
          .transition(t)
          .style("fill", "blue")
        
        // ENTER
        bars.enter().append("rect")
          .attr("class", cssClass)
          .attr('y', d => yScale(maxY - d[1]))
          .attr('x', d => xScale(d[0]))
          .attr("width", 5)
          .attr("height", d => yScale(d[1]))
          .style("fill", "green")
          .transition(t)
          .style("fill", "blue")
      }

      function updateLine(data, cssClass, maxY) {
        var lineFn = d3.line()
                      .x(d => xScale(d[0]))
                      .y(d => yScale(maxY - d[1]))
                      .curve(d3.curveStepBefore) // d3.curveLinear

        var path = chart.select(`path.${cssClass}`)
        if (path.empty()) {
          path = chart.append('path').attr('class', cssClass)
        }
        path
          .attr("d", lineFn(data))
          .attr("stroke", "blue")
          .attr("stroke-width", 2)
          .attr("fill", "none")
      }

      function updateArea(data, cssClass, maxY) {
        var t = d3.transition().duration(500)
        
        var areaFn = d3.area()
                      .x(d => xScale(d[0]))
                      .y0(yScale(0))
                      .y1(d => yScale(maxY - d[1]))

        var path = chart.select(`path.${cssClass}`)
        if (path.empty()) {
          path = chart.append('path').attr('class', cssClass)
        }
        path
          .transition(t)
          .attr("d", areaFn(data))
          .attr("fill", "lightsteelblue")
      }

      function updateChart() {
        var buyData = genData(0, 50)
        var sellData = genData(55, 100)

        var minX = d3.min(buyData, d => d[0])
        var maxX = d3.max(sellData, d => d[0])
        var maxY = d3.max([d3.max(buyData, d => d[1]), d3.max(sellData, d => d[1])])

        // console.log(`X [${minX}, ${maxX}] [0, ${boundingRect.width}]`)
        // console.log(`Y [0, ${maxY}] [0, ${boundingRect.height}]`)
        xScale = xScale.domain([minX, maxX])
        yScale = yScale.domain([0, maxY])

        // AXES
        
        var xAxis = d3.axisBottom(xScale)
        var yAxis = d3.axisLeft(yScale)
        chart.select(".x").call(xAxis)
        chart.select(".y").call(yAxis)

        // BARS
        updateBars(buyData, "buy", maxY)
        updateBars(sellData, "sell", maxY)

        // LINE
        updateLine(buyData, "buy", maxY)
        updateLine(sellData, "sell", maxY)

        // AREA
        updateArea(buyData, "buy-area", maxY)
        updateArea(sellData, "sell-area", maxY)
      }

      updateChart();
      // setInterval(update, 1000)
    </script>
  </body>
</html>